<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ff6b9d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>aibo ãƒªãƒ¢ã‚³ãƒ³</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px;
    }
    
    header {
      text-align: center;
      padding: 20px 0;
      color: white;
    }
    
    header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 600;
    }
    
    header p {
      margin: 8px 0 0;
      opacity: 0.9;
      font-size: 0.95rem;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .card h2 {
      margin: 0 0 16px;
      font-size: 1.1rem;
      color: #555;
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    .input-group label {
      display: block;
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 6px;
    }
    
    .input-group input {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: border-color 0.2s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    
    .btn:active {
      transform: scale(0.96);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .action-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .action-btn {
      background: linear-gradient(135deg, #ff6b9d 0%, #ff8a80 100%);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 20px 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(255,107,157,0.3);
    }
    
    .action-btn:active {
      transform: scale(0.95);
    }
    
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .action-btn .emoji {
      display: block;
      font-size: 2rem;
      margin-bottom: 8px;
    }
    
    .status {
      text-align: center;
      padding: 12px;
      border-radius: 10px;
      margin-top: 16px;
      font-size: 14px;
      display: none;
    }
    
    .status.show {
      display: block;
    }
    
    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
    
    .status.loading {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .settings-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    
    .settings-content {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    
    .settings-content.show {
      display: block;
    }
    
    .device-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #666;
      margin-top: 12px;
    }
    
    .device-info strong {
      color: #333;
    }
    
    .hidden {
      display: none !important;
    }
    
    .setup-required {
      text-align: center;
      padding: 40px 20px;
    }
    
    .setup-required .emoji {
      font-size: 4rem;
      margin-bottom: 16px;
    }
    
    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    
    .button-row .btn {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ• aibo ãƒªãƒ¢ã‚³ãƒ³</h1>
      <p id="headerStatus">è¨­å®šãŒå¿…è¦ã§ã™</p>
    </header>
    
    <!-- è¨­å®šã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <div class="settings-toggle" onclick="toggleSettings()">
        <h2 style="margin:0;">âš™ï¸ è¨­å®š</h2>
        <span id="settingsArrow">â–¼</span>
      </div>
      <div class="settings-content" id="settingsContent">
        <div class="input-group">
          <label>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</label>
          <input type="password" id="tokenInput" placeholder="ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›">
        </div>
        <div class="button-row">
          <button class="btn btn-primary" onclick="saveToken()">ä¿å­˜</button>
          <button class="btn btn-secondary" onclick="fetchDevices()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>
        <div class="device-info" id="deviceInfo" style="display:none;">
          <strong>æ¥ç¶šä¸­ã®aibo:</strong><br>
          <span id="deviceName">-</span>
        </div>
      </div>
    </div>
    
    <!-- æœªè¨­å®šæ™‚ã®è¡¨ç¤º -->
    <div class="card" id="setupRequired">
      <div class="setup-required">
        <div class="emoji">ğŸ”§</div>
        <p>ã¾ãšä¸Šã®ã€Œè¨­å®šã€ã‚’é–‹ã„ã¦ã€<br>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </div>
    
    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="card hidden" id="actionPanel">
      <h2>ğŸ® ãµã‚‹ã¾ã„</h2>
      <div class="action-grid">
        <button class="action-btn" onclick="executeAction('paw')">
          <span class="emoji">ğŸ¤</span>
          ãŠæ‰‹
        </button>
        <button class="action-btn" onclick="executeAction('highFive')">
          <span class="emoji">âœ‹</span>
          ãƒã‚¤ã‚¿ãƒƒãƒ
        </button>
        <button class="action-btn" onclick="executeAction('bark')">
          <span class="emoji">ğŸ—£ï¸</span>
          ã»ãˆã¦
        </button>
        <button class="action-btn" onclick="executeAction('friendly')">
          <span class="emoji">ğŸ’•</span>
          ãªã‹ã‚ˆã—
        </button>
        <button class="action-btn" onclick="executeAction('dance')">
          <span class="emoji">ğŸ’ƒ</span>
          ãƒ€ãƒ³ã‚¹
        </button>
        <button class="action-btn" onclick="executeAction('sing')">
          <span class="emoji">ğŸ¤</span>
          æ­Œã†
        </button>
        <button class="action-btn" onclick="executeAction('stretch')">
          <span class="emoji">ğŸ™†</span>
          ä¼¸ã³
        </button>
        <button class="action-btn" onclick="executeAction('overJoyed')">
          <span class="emoji">ğŸ‰</span>
          å¤§å–œã³
        </button>
      </div>
      <div class="status" id="actionStatus"></div>
    </div>
  </div>

  <script>
    // ========== å®šæ•° ==========
    const API_BASE = 'https://public.api.aibo.com/v1';
    const STORAGE_KEY_TOKEN = 'aibo_token';
    const STORAGE_KEY_DEVICE = 'aibo_device_id';
    const STORAGE_KEY_DEVICE_NAME = 'aibo_device_name';
    
    // ========== çŠ¶æ…‹ç®¡ç† ==========
    let currentToken = '';
    let currentDeviceId = '';
    let currentDeviceName = '';
    
    // ========== åˆæœŸåŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      updateUI();
    });
    
    function loadSettings() {
      currentToken = localStorage.getItem(STORAGE_KEY_TOKEN) || '';
      currentDeviceId = localStorage.getItem(STORAGE_KEY_DEVICE) || '';
      currentDeviceName = localStorage.getItem(STORAGE_KEY_DEVICE_NAME) || '';
      
      document.getElementById('tokenInput').value = currentToken;
    }
    
    function updateUI() {
      const isReady = currentToken && currentDeviceId;
      
      document.getElementById('setupRequired').classList.toggle('hidden', isReady);
      document.getElementById('actionPanel').classList.toggle('hidden', !isReady);
      document.getElementById('headerStatus').textContent = isReady 
        ? `${currentDeviceName || 'aibo'} ã¨æ¥ç¶šä¸­` 
        : 'è¨­å®šãŒå¿…è¦ã§ã™';
      
      if (currentDeviceId) {
        document.getElementById('deviceInfo').style.display = 'block';
        document.getElementById('deviceName').textContent = currentDeviceName || currentDeviceId;
      } else {
        document.getElementById('deviceInfo').style.display = 'none';
      }
    }
    
    // ========== è¨­å®šé–¢é€£ ==========
    function toggleSettings() {
      const content = document.getElementById('settingsContent');
      const arrow = document.getElementById('settingsArrow');
      const isShow = content.classList.toggle('show');
      arrow.textContent = isShow ? 'â–²' : 'â–¼';
    }
    
    function saveToken() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        alert('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      currentToken = token;
      localStorage.setItem(STORAGE_KEY_TOKEN, token);
      
      // ãƒˆãƒ¼ã‚¯ãƒ³å¤‰æ›´æ™‚ã¯ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
      currentDeviceId = '';
      currentDeviceName = '';
      localStorage.removeItem(STORAGE_KEY_DEVICE);
      localStorage.removeItem(STORAGE_KEY_DEVICE_NAME);
      
      updateUI();
      alert('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã‚’æŠ¼ã—ã¦aiboã¨æ¥ç¶šã—ã¦ãã ã•ã„ã€‚');
    }
    
    async function fetchDevices() {
      if (!currentToken) {
        alert('å…ˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/devices`, {
          headers: { 'Authorization': `Bearer ${currentToken}` }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.devices || data.devices.length === 0) {
          alert('aiboãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        
        // æœ€åˆã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ä½¿ç”¨
        const device = data.devices[0];
        currentDeviceId = device.deviceId;
        currentDeviceName = device.nickname || 'aibo';
        
        localStorage.setItem(STORAGE_KEY_DEVICE, currentDeviceId);
        localStorage.setItem(STORAGE_KEY_DEVICE_NAME, currentDeviceName);
        
        updateUI();
        alert(`${currentDeviceName} ã¨æ¥ç¶šã—ã¾ã—ãŸï¼`);
        
      } catch (error) {
        alert(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }
    
    // ========== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ ==========
    const ACTION_MAP = {
      'paw': { category: 'paw', name: 'ãŠæ‰‹' },
      'highFive': { category: 'highFive', name: 'ãƒã‚¤ã‚¿ãƒƒãƒ' },
      'bark': { category: 'bark', name: 'ã»ãˆã¦' },
      'friendly': { category: 'friendly', name: 'ãªã‹ã‚ˆã—' },
      'dance': { category: 'dance', name: 'ãƒ€ãƒ³ã‚¹' },
      'sing': { category: 'sing', name: 'æ­Œã†' },
      'stretch': { category: 'stretch', name: 'ä¼¸ã³' },
      'overJoyed': { category: 'overJoyed', name: 'å¤§å–œã³' }
    };
    
    async function executeAction(actionKey) {
      const action = ACTION_MAP[actionKey];
      if (!action) return;
      
      const statusEl = document.getElementById('actionStatus');
      showStatus('loading', `${action.name} ã‚’å®Ÿè¡Œä¸­...`);
      
      // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
      const buttons = document.querySelectorAll('.action-btn');
      buttons.forEach(btn => btn.disabled = true);
      
      try {
        const response = await fetch(`${API_BASE}/devices/${currentDeviceId}/capabilities/play_motion/execute`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            arguments: {
              Category: action.category,
              Mode: 'NONE'
            }
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        showStatus('success', `${action.name} ã‚’æŒ‡ç¤ºã—ã¾ã—ãŸï¼`);
        
        // 3ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¶ˆã™
        setTimeout(() => {
          statusEl.classList.remove('show');
        }, 3000);
        
      } catch (error) {
        showStatus('error', `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      } finally {
        buttons.forEach(btn => btn.disabled = false);
      }
    }
    
    function showStatus(type, message) {
      const statusEl = document.getElementById('actionStatus');
      statusEl.className = `status show ${type}`;
      statusEl.textContent = message;
    }
    
    // ========== Service Workerç™»éŒ² ==========
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
